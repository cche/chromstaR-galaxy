<tool id="chromstaR" name="chromstaR" version="1.3.1">
    <description>Multivariate ChIP-seq analysis</description>
    <requirements>
        <requirement type="package" version="3.3.0">R</requirement>
        <requirement type="package" version="1.26.4">GenomicRanges</requirement>
        <requirement type="package" version="2.2.1">ggplot2</requirement>
        <requirement type="package" version="1.4.3">foreach</requirement>
        <requirement type="package" version="1.0.10">doParallel</requirement>
        <requirement type="package" version="0.12.2">S4Vectors</requirement>
        <requirement type="package" version="1.10.3">GenomeInfoDb</requirement>
        <requirement type="package" version="2.8.2">IRanges</requirement>
        <requirement type="package" version="1.4.2">reshape2</requirement>
        <requirement type="package" version="1.26.2">Rsamtools</requirement>
        <requirement type="package" version="1.10.1">GenomicAlignments</requirement>
        <requirement type="package" version="1.6.0">bamsignals</requirement>
        <requirement type="package" version="1.0-6">mvtnorm</requirement>
        <requirement type="package" version="1.3.2">optparse</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        Rscript /home/aaron/galaxy/tools/chromstaR/chromstaR.R
		--inputfolder inputfolder
		--experiment.table $experimentTable
		--outputfolder outputfolder
		--numCPU \${GALAXY_SLOTS:-4}
		--binsize $binsize
		--stepsize $stepsize
		--assembly $input8
		--chromosomes $input9
		--remove.duplicate.reads $input10
		--min.mapq $input11
		--prefit.on.chr $input12
		--eps.univariate $input13
		--max.time $input14
		--max.iter $input15
		--read.cutoff.absolute $input16
		--keep.posteriors $input17
		--mode $input18
		--max.states $input19
		--per.chrom $input20
		--eps.multivariate $input21
		--exclusive.table $input22
		]]></command>
	<configfiles>
	<configfile name="experimentTable">
		<!-- TODO -->
#set $counter = 1
#for $sample in $format.rep_inputfile:
file	mark	condition	replicate	pairedEndReads	controlFiles
#if str( $sample.inputfile ) != '':
$sample.inputfile	$sample.mark	$sample.condition	$sample.replicate	$sample.paired	$sample.control
#end if
#end for
</configfile>
	</configfiles>

<inputs>
	<conditional name="format">
		<param type="select" name="fileformat" label="Select input file format">
			<option value="bam">BAM file</option>
			<option value="bed">BED file</option>
		</param>
		<when value="bam">
			<repeat name="rep_inputfile" title="Sample" min="1">
				<param type="data" name="inputfile" format="bam" label="BAM file"/>
				<param type="text" name="condition" label="Condition, could be control, treatement, etc"/>
				<param type="text" name="mark" label="Histone mark for the experiment"/>
				<param type="text" name="replicate" label="Number of replicate"/>
					<param type="select" name="paired" label="Chose wether it is single or paired">
						<option value="FALSE">Single end</option>
						<option value="TRUE">Paired end</option>
					</param>
				<param type="data" name="control" format="bam" optional="True" label="Input file for the sample"/>
			</repeat>
		</when>
		<when value="bed">
			<param type="data" name="chromlen" format="tabular" label="Chromosome length file"/>
			<repeat name="rep_inputfile" title="Sample" min="1">
				<param type="data" name="inputfile" format="bed" label="BED file"/>
				<param type="text" name="condition" label="Condition, could be control, treatement, etc"/>
				<param type="text" name="mark" label="Histone mark for the experiment"/>
				<param type="text" name="replicate" label="Number of replicate"/>
					<param type="select" name="paired" label="Chose wether it is single or paired">
						<option value="FALSE">Single end</option>
						<option value="TRUE">Paired end</option>
					</param>
				<param type="data" name="control" format="bed" optional="True" label="Input file for the sample"/>
			</repeat>
		</when>
	</conditional>
	<param type="integer" name="binsize" value="1000" label="Size of bins"/>
	<param type="integer" name="stepsize" value="500" label="Size of steps"/>
	<param type="boolean" name="removedup" truevalue="TRUE" falsevalue="FALSE" checked="True" label="Choose whether to remove duplicates"/>
	<param type="integer" name="minMapQ" value="10" label="Min Map quality"/>
	<param type="text" name="prefit" label="Name of chromosome to use for prefit"/>
	<param type="float" name="epsuni" value="0.1" label="Univariate Epsilon for Baum-Welch"/>
	<param type="float" name="epsmulti" value="0.01" label="Multivariate Epsilon for Baum-Welch"/>
	<param type="integer" name="maxTime" optional="True" value="60" label="Maximum time for Baum-Welch"/>
	<param type="integer" name="maxIter" value="5000" label="Maximum iterations for Baum-Welch"/>
	<param type="integer" name="readCutoff" value="500" label="Read count cutoff"/>
	<param type="boolean" name="posteriors" truevalue="TRUE" falsevalue="FALSE" checked="True" label="Whether or not to keep posteriors"/>
	<param type="select" name="mode" label="Mode of analysis.">
		<option value="differential">Differential</option>
		<option value="combinatorial">Combinatorial</option>
		<option value="full">Full</option>
		<option value="separate">Separate</option>
	</param>
	<param type="integer" name="states" value="128" label="Maximum number of states"/>
	<param type="boolean" name="perChrom" truevalue="TRUE" falsevalue="FALSE" checked="True" label="Whether or not to do the multivariate part per chromosome"/>
</inputs>
<outputs>
	<!-- check how to create an output for each input -->
	<data name="output1" format="bed" from_work_dir="" />
	<data name="output2" format="pdf" from_work_dir="" />
</outputs>
    <tests>
        <test>
            <param name="input1" value="bsseekerfile"/>
            <param name="input2" value="arabidopsis_bsseeker.txt"/>
            <!-- param name="input3" value="TAIR10_chr_all_chromfile.tsv"/ -->
            <param name="input4" value="arabidopsis_toydata.RData"/>
            <param name="input5" value="chr1"/>
            <param name="input6" value="independent"/>
            <param name="input7" value="--intermediate"/>
	    <!-- param name="input8" value="TAIR10_chr_all.fa"/ -->
            <output name="output1" file="methimpute.RData"/>
            <output name="output2" file="methimpute.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
Options:

  -i INPUTFOLDER, --inputfolder=INPUTFOLDER
		Folder with input files

  -x EXPERIMENT.TABLE, --experiment.table=EXPERIMENT.TABLE
		Experiment table

  -o OUTPUTFOLDER, --outputfolder=OUTPUTFOLDER
		Folder for the output files
  
  -f CONFIGFILE, --configfile=CONFIGFILE
		chromstaR configuration file
  
  -n NUMCPU, --numCPU=NUMCPU
		Number of CPUs to use
  
  -B BINSIZE, --binsize=BINSIZE
		Bin size
  
  -S STEPSIZE, --stepsize=STEPSIZE
		Step size for bin offset
  
  -a ASSEMBLY, --assembly=ASSEMBLY
		Genome assembly
  
  -c CHROMOSOMES, --chromosomes=CHROMOSOMES
		Chromosomes to use in the analysis
  
  -D REMOVE.DUPLICATE.READS, --remove.duplicate.reads=REMOVE.DUPLICATE.READS
		Whether or not to remove duplicate reads. Default is 'TRUE'.
  
  -Q MIN.MAPQ, --min.mapq=MIN.MAPQ
		Minimum mapping quality
  
  -P PREFIT.ON.CHR, --prefit.on.chr=PREFIT.ON.CHR
		Prefit on chromosome
  
  -U EPS.UNIVARIATE, --eps.univariate=EPS.UNIVARIATE
		Univariate epsilon for Baum-Welch
  
  -T MAX.TIME, --max.time=MAX.TIME
		Maximum time for Baum-Welch
  
  -I MAX.ITER, --max.iter=MAX.ITER
		Maximum iterations for Baum-Welch
  
  -R READ.CUTOFF.ABSOLUTE, --read.cutoff.absolute=READ.CUTOFF.ABSOLUTE
		Read count cutoff
  
  -k KEEP.POSTERIORS, --keep.posteriors=KEEP.POSTERIORS
  	Whether or not to keep posteriors. Default is 'TRUE'.
  
  -m MODE, --mode=MODE
  	Mode of analysis. One of 'differential', 'combinatorial', 'full', 'separate'.
  
  -X MAX.STATES, --max.states=MAX.STATES
  	Maximum number of states
  
  -p PER.CHROM, --per.chrom=PER.CHROM
  	Whether or not to do the multivariate part per chromosome. Default is 'TRUE'.
  
  -M EPS.MULTIVARIATE, --eps.multivariate=EPS.MULTIVARIATE
  	Multivariate epsilon for Baum-Welch
  
  -e EXCLUSIVE.TABLE, --exclusive.table=EXCLUSIVE.TABLE
  	Exclusive table
  
  -h, --help
	Show this help message and exit
 
    ]]></help>
  <citations>
      <citation type="doi">10.1101/038612</citation>
  </citations>
</tool>
